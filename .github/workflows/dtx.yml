---
name: Desktop Extension (DXT)
run-name: ${{ github.workflow}} by @${{ github.triggering_actor }} for @${{ github.actor }}

concurrency:
  cancel-in-progress: true
  group: ${{ github.event_name}}-${{ github.ref}}

on:
  push:
  workflow_dispatch:
    inputs:
      ecosystem:
        description: 'Supported ecosystems'
        default: 'python'
        required: false
        type: choice
        options:
          - 'python'

permissions:
    actions: none
    attestations: none
    checks: none
    contents: none
    deployments: none
    discussions: none
    id-token: none
    issues: none
    models: none
    packages: none
    pages: none
    pull-requests: none
    repository-projects: none
    security-events: none
    statuses: none

jobs:
  package:
    concurrency:
      cancel-in-progress: true
      group: ${{ github.workflow}}-${{ matrix.runs-on }}-${{ github.ref }}
    continue-on-error: true
    if: true || always() || cancelled() || failure() || success() # github, inputs, vars, needs
    name: DXT ${{ matrix.package }} ${{ matrix.runs-on }}
    needs: []
    # outputs:
    #   artifact-identifier: ${{ steps.upload.outputs.artifact-identifier }}

    permissions: 
      actions: none
      attestations: none
      checks: none
      contents: none
      deployments: none
      discussions: none
      id-token: none
      issues: none
      models: none
      packages: none
      pages: none
      pull-requests: none
      repository-projects: none
      security-events: none
      statuses: none
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Stepper
        id: stepper
        continue-on-error: true
        env:
          GRACE: "grace"
        # github, inputs, vars, needs, strategy, matrix, steps, job, runner, env
        # 
        if: ${{ ( true || always() || cancelled() || failure() || success() || hashFiles('**/*') ) }}
        run: |
          echo "::group::GITHUB object"
          echo "${{ toJson(github) }}"
          echo "::endgroup::"
          echo "::group::INPUTS object"
          echo "${{ toJson(inputs) }}"
          echo "::endgroup::"
          echo "::group::VARS object"
          echo "${{ toJson(vars) }}"
          echo "::endgroup::"
          echo "::group::NEEDS object"
          echo "${{ toJson(needs) }}"
          echo "::endgroup::"
          echo "::group::STRATEGY object"
          echo "${{ toJson(strategy) }}"
          echo "::endgroup::"
          echo "::group::MATRIX object"
          echo "${{ toJson(matrix) }}"
          echo "::endgroup::"
          echo "::group::STEPS object"
          echo "${{ toJson(steps) }}"
          echo "::endgroup::"
          echo "::group::JOB object"
          echo "${{ toJson(job) }}"
          echo "::endgroup::"
          echo "::group::RUNNER object"
          echo "${{ toJson(runner) }}"
          echo "::endgroup::"
          echo "::group::ENV object"
          echo "${{ toJson(env) }}"
          echo "::endgroup::"
        # shell:
        timeout-minutes: 1
        working-directory: .
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 1
      - name: Install uv
        uses: astral-sh/setup-uv@e92bafb6253dcd438e0484186d7669ea7a8ca1cc # v6.4.3
        with:
          working-directory: src/${{ matrix.package }}
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version-file: "src/${{ matrix.package }}/.python-version"
      - name: Install dependencies
        working-directory: src/${{ matrix.package }}
        run: |
          uv venv --clear --relocatable --link-mode "copy" server/venv
      - name: Activate (Windows)
        if: matrix.runs-on == 'windows-latest'
        working-directory: src/${{ matrix.package }}
        run: |
          server/venv/Scripts/Activate.ps1
        shell: powershell
      - name: Activate (non-Windows)
        if: ${{ ! (matrix.runs-on == 'windows-latest') }}
        working-directory: src/${{ matrix.package }}
        run: |
          source server/venv/bin/activate
      - name: Install
        working-directory: src/${{ matrix.package }}
        run: |
          uv sync --frozen --active
      - name: Upload Virtual
        id: upload
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: venv-${{ matrix.package }}-${{ matrix.runs-on }}
          path: src/${{ matrix.package }}/server/venv
          retention-days: 1
    strategy:
      fail-fast: false
      matrix:
        runs-on: 
          - ubuntu-latest
          - macos-latest
          - windows-latest
        package:
          - redshift-mcp-server
      max-parallel: 3
    timeout-minutes: 15
    
